<!DOCTYPE html>

<html>

<head>
    <link rel="icon" 
      type="image/png" 
      href="favicon.ico">
    <title>B612</title>
</head>

<style>
    *{margin:0; padding:0; background-color: black; font-family:'Courier New', Courier, monospace}
    #display{
        width: 100vmin;
        height:100vmin;
        display:block;
        margin:auto;
    }
    .crisp{
        image-rendering:pixelated;    
    }
    .pac{
        background-color:#888;
        color:#fff;
        padding: 1em;
    }
</style>

<!-- http://davidbau.com/archives/2010/01/30/random_seeds_coded_hints_and_quintillions.html -->
<script src="seedrandom.js"> </script>

<!-- game code -->
<script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>

<script src="MathEx.js"></script>
<script src="perfmon.js"></script>
<script src="Camera.js"></script>
<script src="RendererWebGL.js"> </script>
<script src="RendererCanvas.js"> </script>
<script src="Assets.js"> </script>
<script src="GameObject.js"> </script>
<script src="Sprite.js"> </script>
<script src="Star.js"> </script>
<script src="Planet.js"> </script>
<script src="Actor.js"> </script>
<script src="Game.js"></script>
<script src="Oracle.js"></script>
<script>

"use strict";

var renderContext = undefined;
const RM_HIRES = "hires";
const RM_RETRO = "retro";
var renderMode = RM_HIRES;

function setRenderMode(mode){    
    if (mode==renderMode){
        return;
    }
    console.log("setRenderMode",mode)
    renderMode = mode;
    if (mode==RM_HIRES){        
        setRes(1600,1600,false);        
    }
    if (mode==RM_RETRO){        
        setRes(128,128,true);
    }
}


var planets = [];
var stars = [];
var perfmon = new PerfMon();
var player = undefined;

var tsecond = 0

var time_to_use = 0;
const time_step = 10;

function make_stars(){
    var bg = new GameObject();
    game.objects.background.push(bg);
    bg.renderer = new RenderSprite("bg");
    bg.position = {x:400,y:400};
    bg.scale = 2;
    bg.z_1 = 0.1;

    stars = [];

    Math.seedrandom("starfield");
    for(let i=0;i<50;i++){
        let go = new GoStar();
        game.objects.background.push(go);
        go.position = {x:MathEx.randRange(10,790), y:MathEx.randRange(10,790)};
        go.s = MathEx.randRange(0.03,0.075);
        go.k = MathEx.randomAngle();       
        go.z_1 = MathEx.randRange(0.2,0.7); 
        stars.push(go);
    }

    let piasecki = [[174,215],[326,259],[370,325],[430,379],[600,450],[535,524],[406,468]];
    for(let i in piasecki){
        let [x,y] = piasecki[i];
        let go = new GoStar();
        game.objects.background.push(go);
        go.position = {x:x,y:y+20};
        go.s = 0.2;
        go.k = MathEx.randomAngle(); //-i*0.05;
        go.z_1 = 0.2; 
    }

}    

var cam_back = new Camera(0);
var cam_front = new Camera(0);
var game = new Game();
Game.currentGame = game;


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function render(){
    var t1 = perfmon.time;

    if (rose!==undefined) {
        let t = rose.globalPosition;
        for(let p of planets){
            const pos = p.globalPosition;
            p.lightRotation = Math.PI*0.7+Math.atan2(t.y-pos.y,t.x-pos.x);
        }
    }else{        
        for(let p of planets){
            const pos = p.globalPosition;
            const t = mouse;
            p.lightRotation = Math.PI*0.7+Math.atan2(t.y-pos.y,t.x-pos.x);
        }
    }       


    if (renderContext.BeginScene()){
        /*
        path = Oracle.getOmniJumpPathPrediction(player,3000,50);
        for(let i in stars){
            stars[i].position = i<path.length ? {... path[i].p} : {x:0,y:0};
        }
        */

        //camera.opacity = 1.;
        let cam_target = getPlanet(player);
        if (player.behaviour instanceof BeaJump){
            cam_target = player;
        }
        cam_back.setTarget(player);
                
        renderContext.camera = cam_back;
        GameObject.RenderAll(game.objects.background);
                
        renderContext.camera = cam_front;
        GameObject.RenderAll(game.objects.solid);        

        renderContext.EndScene();
    }
    
    perfmon.watch("rx",t1);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function getPlanet(go){
    if (go===undefined){
        return undefined;
    }
    let be = go.behaviour;
    if (be!==undefined){
        return be.planetLocation;
    }else{
        return undefined;
    }
}

let rose = undefined, retro = undefined;
let prince, fox, sheep, box, scarf, bush, star;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function physics(dt){
    time_to_use=Math.max(Math.min(300,time_to_use+dt),0);
    while(time_to_use>time_step){
        let t1 = perfmon.time;
        time_to_use-=time_step;
        
        GameObject.UpdateAll(game.objects.solid);
        GameObject.UpdateAll(game.objects.background);
        for(let go of game.objects.solid){
            go.DispatchAll();
        }

        if (rose!==undefined){            
            if (rose===getPlanet(player)){
                player.spawnAtPlanet(getPlanet(rose),rose.globalRotation);
            }
            if (getPlanet(rose)===getPlanet(player)){
                let ix = Math.round(MathEx.randRange(0,planets.length-1));
                let new_planet = planets[ix]
                rose.spawnAtPlanet(new_planet,MathEx.randomAngle());
            }else{
            }
        }

        {
            let cam_target = player;
            if (player.behaviour instanceof BeaStand){
                cam_target = player.behaviour.planet;
            }    
            if (player.behaviour instanceof BeaJump){
                cam_target = player.behaviour.p2 || player.behaviour.p1;
            }    
            //camera.setTarget(cam_target);
            cam_front.Update();
            cam_back.Update();
        }


        perfmon.watch("ph",t1);
    }
}

let ts1, ts2;

let tr = 0

const MS_PER_FRAME = 20;
let cnt_frames = 0;

function szround(v,m){
    return Math.round(m*v)/m;
}

function animationFrame(timestamp){
    try{
        timestamp = perfmon.time;
        if (ts1===undefined){
            ts1 = timestamp;
            ts2 = timestamp;
        }   
        { 
            const dt = ts2-ts1;
            let cfdt = Math.sin(perfmon.time*0.001);
            //cfdt*=cfdt;
            physics(dt);
            tr=Math.min(120,tr+dt);
            while(tr>MS_PER_FRAME){
                render();
                cnt_frames+=1;
                tr-=MS_PER_FRAME;
            }
        }

        {
            let dt = perfmon.time - tsecond 
            if (dt>1000){
                const metrics = perfmon.metrics;
                // structure of one second of the game:
                const time_in_frame = PerfMon.sum(metrics.ph) + PerfMon.sum(metrics.rx);
                const time_in_glx = PerfMon.sum(metrics.gl);
                const time_in_rdx = PerfMon.sum(metrics.rx);
                const time_in_phy = PerfMon.sum(metrics.ph);
                const pload = time_in_frame*100/dt;
                const pphy = time_in_phy*100/time_in_frame;
                const prdx = time_in_rdx*100/time_in_frame;
                const pglx = time_in_glx*100/time_in_rdx;
                if (pload>0){
                    document.getElementById("fps").innerHTML = `CPU:${szround(pload,100)}% R:${szround(prdx,100)}% (${szround(pglx,100)}%) P:${szround(pphy,100)}%`
                }else{
                    document.getElementById("fps").innerHTML = '';
                }

                perfmon.reset();
                tsecond = perfmon.time;
            }
        }

        if (cnt_frames>10){
            //throw "meh" + cnt_frames
        }

        perfmon.metrics.ts.push(ts2-ts1);
        ts1 = ts2;
        ts2 = timestamp;    
        window.requestAnimationFrame(animationFrame);
    }catch(e){
        console.log(e)
        throw e;
    }

    //window.requestAnimationFrame(animationFrame);
}


function shuffle(array) {
  let currentIndex = array.length,  randomIndex;

  // While there remain elements to shuffle...
  while (currentIndex != 0) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }

  return array;
}

function make_demo(){
    planets = []
    for(let y=0;y<3;y++){
        var nx = 3;
        if (y==1) {nx = 4;}
        for(let x=0;x<nx;x++)    
        {
            let p = new GoPlanet(`level1-${x}-${y}`,(x+1-(y%2)*0.5)*200,(y-1+0.5)*230+400-230*0.5);
            p.position.x+=Math.random()*20-10;
            p.position.y+=Math.random()*20-10;
            planets.push(p)
            game.objects.solid.push(p);
        }
    } 

    prince = new GoActor("prince");    
    game.objects.solid.push(prince);
    prince.spawnAtPlanet(planets[0],MathEx.randomAngle());    

    fox = new GoActor("fox");
    game.objects.solid.push(fox);
    fox.spawnAtPlanet(planets[1],MathEx.randomAngle())
    

    sheep = new GoActor("sheep");
    game.objects.solid.push(sheep);
    sheep.spawnAtPlanet(planets[2],MathEx.randomAngle())

    rose = new GoActor("rose");
    game.objects.solid.push(rose);
    rose.effect = new EfBlink();
    rose.spawnAtPlanet(planets[3],MathEx.randomAngle())

    box = new GoActor("box");
    game.objects.solid.push(box);
    box.spawnAtPlanet(planets[1],MathEx.randomAngle())
    box.radius*=0.7;

    retro = new GoActor("retro");
    game.objects.solid.push(retro);
    retro.spawnAtPlanet(planets[planets.length-1],MathEx.randomAngle())

    scarf = new GoActor("scarf");
    game.objects.solid.push(scarf);
    scarf.spawnAtPlanet(planets[planets.length-2],MathEx.randomAngle());

    bush = new GoActor("bush");
    game.objects.solid.push(bush);
    bush.spawnAtPlanet(planets[planets.length-3],MathEx.randomAngle());
    
    star = new GoActor("star")
    game.objects.solid.push(star);
    star.spawnAtPlanet(planets[planets.length-4],MathEx.randomAngle());

    player = star;
    player.addHandler(GameEvent.JUMP,function(){
        navigator.vibrate(30);
        synth.triggerAttack("C3");
        
    });
    player.addHandler(GameEvent.TOUCHDOWN,function(that){
        navigator.vibrate(30);
        synth.triggerRelease();
        
        let planet = getPlanet(that);
        if (planet===getPlanet(retro) || planet===retro){
            let mode = RM_HIRES;
            if (renderMode == mode) mode = RM_RETRO;
            setRenderMode(mode);
        }    
    });
    
    
    GameObject.UpdateAll(game.objects.solid);

    ai_random(fox);
    ai_random(prince);
    ai_random(sheep);
}

function make_intro(){
    var p1 = new GoPlanet(`level1-0-0`,300,400);
    game.objects.solid.push(p1);
    var p2 = new GoPlanet(`level1-0-1`,500,400);
    game.objects.solid.push(p2);
    planets = [p1,p2];
    prince = new GoActor("prince");
    prince.spawnAtPlanet(p1,0);
    game.objects.solid.push(prince);
    player = prince;
}

const synth = new Tone.AMSynth({
			harmonicity: 2.5,
			oscillator: {
				type: "fatsawtooth"
			},
			envelope: {
				attack: 0.1,
				decay: 0.2,
				sustain: 0.2,
				release: 2 // 0.3
			},
			modulation: {
				type: "square"
			},
			modulationEnvelope: {
				attack: 0.5,
				decay: 0.01
			}
		}).toDestination();


const bgsynth = new Tone.AMSynth({
			harmonicity: 2.5,
			oscillator: {
				type: "fatsawtooth"
			},
			envelope: {
				attack: 0.1,
				decay: 0.2,
				sustain: 0.2,
				release: 2 // 0.3
			},
			modulation: {
				type: "square"
			},
			modulationEnvelope: {
				attack: 0.5,
				decay: 0.01
			}
		}).toDestination();

function main(){
    console.log("main().enter")
    renderContext = new RendererWebGL(800,800);

    let tick = new Date().now;    
    Promise.all([
        fetch('assets/planet.vsh.glsl?'+tick).then(x=>x.text()),
        fetch('assets/planet.fsh.glsl?'+tick).then(x=>x.text()),
        fetch('assets/sprite.vsh.glsl?'+tick).then(x=>x.text()),
        fetch('assets/sprite.fsh.glsl?'+tick).then(x=>x.text())
    ]).then(([vsh,fsh,svsh,sfsh]) => {        
        renderContext.prepstage(vsh,fsh,svsh,sfsh);        
    });    

    animationFrame();

    setRes(1600,1600,false); // FIXME

    //var go = new GameObject();
    //go.renderer = new RenderSprite("planet");
    //go.position = {x:128,y:128};

    make_stars();

    //make_intro();
    make_demo();
    
    console.log("main().exit");
}

function ai_random(actor){
    let delay = Math.round(MathEx.randRange(600,1600));
    setTimeout(function() {
        ai_random(actor);
        actor.jump()
    }
    ,delay);    
}


function setFullScreen() {
  var doc = window.document;
  var docEl = doc.documentElement;
  docEl = document.getElementById("display");

  var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
  var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;
  
  if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
    requestFullScreen.call(docEl);
  }

}


function toggleFullScreen() {
  var doc = window.document;
  var docEl = doc.documentElement;
  docEl = document.getElementById("display");

  var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
  var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

  if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
    requestFullScreen.call(docEl);
  }
  else {
    cancelFullScreen.call(doc);
  }
}

document.onclick = function(){
    player.jump();
    //bgsynth.triggerAttack("C2");
    //bgsynth.triggerAttack("E2");
    //bgsynth.triggerAttack("G2");
}

document.ondblclick = function(){
    setFullScreen();
}

var mouse = { x:0, y:0};

document.onmousemove = function(e){
    mouse = {x:e.offsetX, y:e.offsetY};
}

function setRes(sx,sy,crisp){
    let canvas = document.getElementById("display");    
    canvas.width = sx;
    canvas.height= sy;
    if (crisp){
        canvas.classList.add("crisp");
    }else{
        canvas.classList.remove("crisp");
    }
    renderContext.gx.viewport(0,0,sx,sy);
}

</script>


<body onload="main()">
    <span id="fps" style="position:absolute;top:0;left:0;color:white">Loading...</span>
    <canvas id="display"></canvas>
    <br>
    <button id="toggle_fullscreen" class="pac" onclick="toggleFullScreen()">Full Screen</button>
    <!--
    <button onclick="setRes(800,800)" class="pac">800</button>
    <button onclick="setRes(200,200)" class="pac">200</button>
    <button onclick="setRes(96,96)" class="pac">96</button>
    -->

</body>


</html>
